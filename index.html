<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Funded Proposal Library</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --black: #000000;
      --white: #FFFFFF;
      --gold: #FFB300;
      --light-gray: #F5F5F5;
      --dark-gray: #333333;
    }

    html, body {
      height: auto;
      min-height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
      background-color: var(--white);
      color: var(--black);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 20px 0 20px; /* remove bottom padding */
    }

    .filters-panel, .table-panel {
      background-color: var(--white);
      border: none; /* remove all borders */
      border-radius: 0; /* remove rounded corners */
      padding: 25px;
      box-shadow: none; /* remove shadows */
      margin-bottom: 30px;
    }

    .filters-title {
      color: var(--black);
      font-size: 1.3rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gold);
      display: inline-block;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      color: var(--black);
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .filter-group select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: var(--white);
      color: var(--black);
      font-size: 0.95rem;
    }

    #filtered-table {
      width: 100% !important;
    }

    #filtered-table th {
      background-color: var(--black);
      color: var(--white);
      padding: 12px 15px;
      font-weight: 600;
    }

    #filtered-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    #filtered-table tr:nth-child(even) {
      background-color: var(--light-gray);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="filters-panel">
      <h2 class="filters-title">Filter Projects</h2>
      <div class="filter-grid">
        <div class="filter-group">
          <label for="filter-type">Project Type</label>
          <select id="filter-type">
            <option value="">All Types</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-field">Research Field</label>
          <select id="filter-field">
            <option value="">All Fields</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-division">Division</label>
          <select id="filter-division">
            <option value="">All Divisions</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-sponsor">Sponsor</label>
          <select id="filter-sponsor">
            <option value="">All Sponsors</option>
          </select>
        </div>
      </div>
    </div>

    <div class="table-panel">
      <table id="filtered-table" class="display">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfzCIqMwAFLL_aerMGhx6no1vHr7F2IFI6gkLjrBRmZtQYGf4IB_MHkCEtrNDUUpI1L8uIMNaUfYa9/pub?gid=0&single=true&output=csv";
    let dataTable;

    function populateDropdown(selector, data, columnIndex, columnName) {
      if (columnIndex === -1) return;
      const values = data.map(row => row[columnIndex]?.toString().trim())
        .filter(cell => cell && cell !== "" && !/^n\/a$/i.test(cell));
      const unique = [...new Set(values)].sort();
      const dropdown = $(selector);
      unique.forEach(val => {
        dropdown.append(`<option value="${val}">${val}</option>`);
      });
    }

    Papa.parse(csvUrl, {
      download: true,
      header: false,
      complete: function (results) {
        try {
          let rawData = results.data.filter(row => row.some(cell => cell && cell.toString().trim() !== ""));
          const rawHeaders = rawData.shift().map(h => h.toString().trim());

          const keyIdx = rawHeaders.indexOf("Key");
          if (keyIdx > -1) rawHeaders.splice(keyIdx, 1);

          const headers = rawHeaders;
          const typeIdx = headers.indexOf("Type");
          const fieldIdx = headers.indexOf("Field/Department");
          const divisionIdx = headers.indexOf("IC/Division");
          const sponsorIdx = headers.indexOf("Sponser");

          $("#filtered-table thead").append("<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>");

          const tbody = $("#filtered-table tbody");
          rawData.forEach(row => {
            if (keyIdx > -1) row.splice(keyIdx, 1);
            const tr = $("<tr>");
            row.forEach(cell => tr.append(`<td>${cell}</td>`));
            tbody.append(tr);
          });

          dataTable = $("#filtered-table").DataTable({
            dom: '<"top"<"table-header"f>l<"table-controls"ip>>rt<"bottom"ip>',
            language: {
              search: "_INPUT_",
              searchPlaceholder: "Search projects...",
              lengthMenu: "Show _MENU_ projects",
              info: "Showing _START_ to _END_ of _TOTAL_ projects",
              infoEmpty: "No projects found",
              infoFiltered: "(filtered from _MAX_ total projects)",
              zeroRecords: "No matching projects found"
            }
          });

          const getIndex = name => headers.indexOf(name);
          populateDropdown("#filter-type", rawData, getIndex("Type"), "Type");
          populateDropdown("#filter-field", rawData, getIndex("Field/Department"), "Field/Department");
          populateDropdown("#filter-division", rawData, getIndex("IC/Division"), "IC/Division");
          populateDropdown("#filter-sponsor", rawData, getIndex("Sponser"), "Sponser");

          $("#filter-type, #filter-field, #filter-division, #filter-sponsor").on("change", function () {
            dataTable.columns(getIndex("Type")).search($("#filter-type").val());
            dataTable.columns(getIndex("Field/Department")).search($("#filter-field").val());
            dataTable.columns(getIndex("IC/Division")).search($("#filter-division").val());
            dataTable.columns(getIndex("Sponser")).search($("#filter-sponsor").val());
            dataTable.draw();
          });

        } catch (err) {
          console.error("Error processing CSV data:", err);
          alert("Error loading data. See console for details.");
        }
      },
      error: function (err) {
        console.error("Error loading CSV:", err);
        alert("Failed to load data file.");
      }
    });
  </script>
</body>
</html>
